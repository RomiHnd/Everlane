(self.webpackChunk_klaviyo_onsite_modules=self.webpackChunk_klaviyo_onsite_modules||[]).push([[7327],{50154:function(e,t,n){"use strict";var a=n(21889);n(56816);const s="kl-post-identification-sync",r=JSON.stringify([]),i=()=>{try{if("undefined"!=typeof localStorage&&null!==localStorage)return localStorage}catch(e){}return null},o=(e,t)=>{(async e=>{const t=i();if(!t)return;const n=t.getItem(s),a=null===n?[]:JSON.parse(n);a.push(e),a.length>1e4&&a.shift(),t.setItem(s,JSON.stringify(a))})(e).finally((()=>{t&&t()}))},l=(e=1e3)=>(async e=>{const t=i();if(!t)return{events:[],deleteCallback:async()=>{}};const n=JSON.parse(t.getItem(s)||r),a=n.slice(0,e),o=n.slice(e);return{events:a||[],deleteCallback:async()=>{t.setItem(s,JSON.stringify(o))}}})(e),c=()=>(()=>{const e=i();e&&e.removeItem(s)})(),u=(e,t)=>{var n;const a=(new Date).toISOString(),s={name:e.event,time:(null==(n=e.properties)?void 0:n.time)||a,properties:e.properties||{}};o(s,t)};var p=n(87789),d=n.n(p),m=(n(92461),n(44159),n(60873),n(37237)),f=n(60485),y=n(20265),h=n(34273);n(70917),n(93677),n(84304),n(75723),n(20696),n(38528),n(72418);const v=new Set(["$exchange_id","email","id","$email","$id","$anonymous","$phone_number"]),b=["name","properties"];let g=!1;const _=(e,t,n,a,s)=>{const r=((e,t,n,a)=>({data:{type:"event-bulk-create",attributes:{profile:{data:{type:"profile",attributes:Object.assign({},t)}},events:{data:e.map((e=>{const{name:t,properties:a}=e,s=d()(e,b),r=Object.assign({},a,n||{}),i=r.service;delete r.service;const o="klaviyo"===i?{name:t,service:i}:{name:t};return{type:"event",attributes:Object.assign({metric:{data:{type:"metric",attributes:o}}},s,{properties:r})}}))}},relationships:a}}))(e,n,a,s);return(0,f.W)((()=>((e,t)=>fetch(`https://a.klaviyo.com/client/event-bulk-create/?company_id=${e}`,{method:"POST",headers:Object.assign({"Access-Control-Allow-Headers":"*","Content-Type":"application/json"},(0,m.h)(),{revision:"2025-01-15"}),body:JSON.stringify(t)}))(t,r)),5,1e3+1e3*Math.random(),[429])},k={$exchange_id:"_kx",email:"email",$email:"email",$phone_number:"phone_number",phone_number:"phone_number",$id:"external_id",id:"id",$kid:"id",$anonymous:"anonymous_id"},w=e=>{let t={};return Object.keys(k).forEach((n=>{if(a=n,!Set.prototype.has.call(v,a))return;var a;const s=e[n];if(!s)return;const r=("$email"===n||"email"===n)&&!(0,y.v)(s),i="$phone_number"===n&&!(0,h.y)(s);r||i||(t=Object.assign({},t,{[k[n]]:s}))})),t},O=async(e,t,n,a,s)=>{if(0===e.events.length)return;const r=await _(e.events,t,n,a,s);if(429===r.status&&console.warn(`KL: Saving event cache due to rate limit. Status: ${r.status}`),r.status>=500)throw new Error(`Saving event cache due to failed request. Status: ${r.status}`);await(null==e||null==e.deleteCallback?void 0:e.deleteCallback());const i=await l();return O(i,t,n,a,s)},S=async(e,t,n,a,s)=>{const r=e||window.__klKey;if(!r||g)return;const i=w(t);if(i&&0!==Object.keys(i).length){g=!0;try{const e=await l();await O(e,r,i,n,s),c(),null==a||a()}catch(e){if(e instanceof Error)throw e;throw new Error("Failed to send bulk events")}finally{g=!1}}};(()=>{(0,a.e)("cacheEvent",u),(0,a.e)("sendCachedEvents",S)})()},87789:function(e){e.exports=function(e,t){if(null==e)return{};var n={};for(var a in e)if({}.hasOwnProperty.call(e,a)){if(t.includes(a))continue;n[a]=e[a]}return n},e.exports.__esModule=!0,e.exports.default=e.exports}},function(e){e.O(0,[2462],(function(){return t=50154,e(e.s=t);var t}));e.O()}]);